name: deploy-ec2
on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-ec2
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            rm -rf "$HOME/BookPortal" || true
            git clone https://github.com/sgoettschMSCS/book-portal.git "$HOME/BookPortal"
            cd "$HOME/BookPortal"
            unzip -o dbData.zip -d dbData || true
            sed -i 's/mvn -f \/usr\/src\/app\/pom.xml clean package/mvn -f \/usr\/src\/app\/pom.xml clean package -DskipTests/' book-portal-be/Dockerfile
            docker compose down || true
            docker compose up -d --build
            docker ps
